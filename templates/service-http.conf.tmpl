# /opt/balancer/templates/service-http.conf.tmpl
# Шаблон для обычных HTTP сервисов (без FastAPI-специфичных эндпоинтов)

# Upstream для {SERVICE_NAME}
upstream {SERVICE_NAME}_backend {
    server {BACKEND_HOST}:{BACKEND_PORT} max_fails=3 fail_timeout=30s;
    keepalive 32;
    keepalive_requests 100;
}

# HTTP -> HTTPS редирект
server {
    listen 80;
    listen [::]:80;
    server_name {DOMAIN};

    # Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS сервер
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name {DOMAIN};

    # SSL сертификаты
    ssl_certificate /etc/letsencrypt/live/{DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{DOMAIN}/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/{DOMAIN}/chain.pem;

    # Подключение общих параметров
    include /etc/nginx/snippets/ssl-params.conf;
    include /etc/nginx/snippets/security-headers.conf;

    # Логи для сервиса
    access_log /var/log/nginx/{SERVICE_NAME}-access.log detailed;
    error_log /var/log/nginx/{SERVICE_NAME}-error.log warn;

    # IP фильтрация (опционально, раскомментировать при необходимости)
    # allow 192.168.1.0/24;
    # allow 10.0.0.0/8;
    # deny all;

    # Rate limiting
    limit_req zone=general burst=20 nodelay;

    # Основной location
    location / {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_backend;

        # Обработка ошибок upstream
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 5s;
    }

    # Health check endpoint
    location /health {
        access_log off;
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_backend/health;
    }

    # WebSocket support (опционально)
    # location /ws {
    #     include /etc/nginx/snippets/proxy-params.conf;
    #     proxy_pass http://{SERVICE_NAME}_backend;
    #
    #     proxy_http_version 1.1;
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection $connection_upgrade;
    #
    #     proxy_read_timeout 86400;
    # }

    # Кеширование статических файлов (опционально)
    # location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|otf)$ {
    #     proxy_cache STATIC;
    #     proxy_cache_valid 200 7d;
    #     proxy_cache_valid 404 1m;
    #     proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
    #
    #     add_header X-Cache-Status $upstream_cache_status;
    #     expires 7d;
    #     access_log off;
    #
    #     include /etc/nginx/snippets/proxy-params.conf;
    #     proxy_pass http://{SERVICE_NAME}_backend;
    # }
}
