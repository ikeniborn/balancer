# /opt/balancer/templates/service-frontend-proxy.conf.tmpl
# Для случаев когда frontend в отдельном контейнере

# Upstream для frontend контейнера
upstream {SERVICE_NAME}_frontend {
    server {BACKEND_HOST}:{BACKEND_PORT} max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# HTTP -> HTTPS редирект
server {
    listen 80;
    listen [::]:80;
    server_name {DOMAIN};

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS сервер для проксирования
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name {DOMAIN};

    ssl_certificate /etc/letsencrypt/live/{DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{DOMAIN}/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/{DOMAIN}/chain.pem;

    include /etc/nginx/snippets/ssl-params.conf;
    include /etc/nginx/snippets/security-headers.conf;

    access_log /var/log/nginx/external-{SERVICE_NAME}-access.log detailed;
    error_log /var/log/nginx/external-{SERVICE_NAME}-error.log warn;

    limit_req zone=general burst=50 nodelay;

    location / {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_frontend;
    }

    # Кеширование статики от upstream
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2|ttf|eot|otf)$ {
        proxy_cache STATIC;
        proxy_cache_valid 200 7d;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;

        add_header X-Cache-Status $upstream_cache_status;
        expires 7d;

        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_frontend;
    }
}
