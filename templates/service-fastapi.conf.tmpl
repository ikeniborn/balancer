# /opt/balancer/templates/service-fastapi.conf.tmpl

# Upstream для {SERVICE_NAME}
upstream {SERVICE_NAME}_backend {
    server {BACKEND_HOST}:{BACKEND_PORT} max_fails=3 fail_timeout=30s;
    keepalive 32;
    keepalive_requests 100;
}

# HTTP -> HTTPS редирект
server {
    listen 80;
    listen [::]:80;
    server_name {DOMAIN};

    # Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
        allow all;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS сервер
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name {DOMAIN};

    # SSL сертификаты
    ssl_certificate /etc/letsencrypt/live/{DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/{DOMAIN}/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/{DOMAIN}/chain.pem;

    # Подключение общих параметров
    include /etc/nginx/snippets/ssl-params.conf;
    include /etc/nginx/snippets/security-headers.conf;

    # Логи для сервиса
    access_log /var/log/nginx/{SERVICE_NAME}-access.log detailed;
    error_log /var/log/nginx/{SERVICE_NAME}-error.log warn;

    # IP фильтрация (опционально, раскомментировать при необходимости)
    # allow 192.168.1.0/24;
    # allow 10.0.0.0/8;
    # deny all;

    # Rate limiting для API
    limit_req zone=api burst=50 nodelay;

    # Основной location для API
    location / {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_backend;

        # Обработка ошибок upstream
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        proxy_next_upstream_tries 2;
        proxy_next_upstream_timeout 5s;
    }

    # Health check endpoint (FastAPI)
    location /health {
        access_log off;
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_backend/health;
    }

    # OpenAPI документация (опционально ограничить по IP)
    location /docs {
        # allow 192.168.1.0/24;
        # deny all;
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_backend/docs;
    }

    location /redoc {
        # allow 192.168.1.0/24;
        # deny all;
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_backend/redoc;
    }

    location /openapi.json {
        # allow 192.168.1.0/24;
        # deny all;
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_backend/openapi.json;
    }

    # WebSocket support для FastAPI
    location /ws {
        include /etc/nginx/snippets/proxy-params.conf;
        proxy_pass http://{SERVICE_NAME}_backend;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        proxy_read_timeout 86400;
    }

    # Отключение кеширования для API (можно включить для GET запросов)
    # location ~ ^/api/v1/(readonly|public)/ {
    #     proxy_cache API;
    #     proxy_cache_valid 200 5m;
    #     proxy_cache_methods GET HEAD;
    #     proxy_cache_key "$scheme$request_method$host$request_uri";
    #
    #     add_header X-Cache-Status $upstream_cache_status;
    #
    #     include /etc/nginx/snippets/proxy-params.conf;
    #     proxy_pass http://{SERVICE_NAME}_backend;
    # }
}
